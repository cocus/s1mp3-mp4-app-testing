#include <stdint.h>
#include "ATJ2085_Ports.h"

#ifndef __SDCC
#define __naked
#define __sdcccall(x)
#define __sfr unsigned char
#define __at(x)
#endif

#if 0
void main(void);
void init(void) __naked
{
    __asm__("push bc"); // caller stack
    __asm__("push de"); // caller stack
    __asm__("ld hl, #0xFFF0");
    __asm__("add hl, sp");
    __asm__("ld sp, hl");

    main();
    __asm__("ret");
/*
    __asm__("push hl"); // caller stack
    __asm__("push bc"); // caller stack

    __asm__("ld hl, #0");
    __asm__("add hl, sp");
    __asm__("ld b, h");
    __asm__("ld c, l");

    __asm__("ld hl, #0xFFF0");
    __asm__("add hl, sp");
    __asm__("ld sp, hl");

    __asm__("push bc"); // my SP

    __asm__("push de"); // my SP

    main();

    //__asm__("pop af");
    __asm__("pop de");
    //__asm__("pop bc");
    //__asm__("pop hl");

    __asm__("pop hl"); // original callee's sp

    __asm__("ld sp, hl");

    __asm__("pop bc"); // caller stack
    __asm__("pop hl"); // caller stack

    __asm__("ret");*/
}
#endif

__sfr __at(WATCHDOG_REG) REG_WATCHDOG;

void Watchdog_Pet(void)
{
    REG_WATCHDOG |= WATCHDOG_RESET;
}

uint8_t API_RST8_no_params(uint8_t fun) __naked __sdcccall(1)
{
    (void)fun;
    __asm__("jp 0x8");
}

void API_RST10_one_param(uint16_t fun, uint16_t param) __naked __sdcccall(1)
{
    (void)fun;
    (void)param;
    __asm__("jp 0x10");
}

void API_RST10_two_param(uint16_t fun /* hl */, uint16_t param1 /* de */, uint16_t param2 /* stack */) __naked __sdcccall(1)
{
    (void)fun;
    (void)param1;
    (void)param2;
    __asm__("pop bc"); /* param2 -> BC */
    __asm__("jp 0x10");
}

void API_RST20_two_param(uint8_t fun /* a */, uint16_t param1 /* stack */, uint16_t param2 /* de */) __naked __sdcccall(1)
{
    (void)fun;
    (void)param1;
    (void)param2;
    __asm__("pop bc"); /* param1 -> BC */
    __asm__("jp 0x20");
}

void API_RST20_one_param(uint8_t fun /* a */, uint16_t param1 /* stack? */) __naked __sdcccall(1)
{
    (void)fun;
    (void)param1;
    __asm__("jp 0x20");
}

// ACTAPI begin
// Software Interrupt entrance
//**************************************************************************
// api entry
#define RSTFastAPI 0x08    // Fast API
#define FFSDCardAPI 0x0c   // Fast SD card API
#define RSTBankAPI 0x10    // Bank API (relatively slow)
#define I2CDrvAPI 0x14     // I2C Driver entry
#define RSTStgAPI 0x18     // Storage driver dedicated API entry
#define SDRAMAPI 0x1c      // SDRAM Driver entry
#define RSTDisplayAPI 0x20 // Display driver dedicated API entry
#define RSTFSAPI 0x28      // File system driver dedicated API entry
#define RSTSysErrAPI 0x30  // System error handling dedicated API entry
//**************************************************************************
#define API_SDDR_FastNo 0x00
#define API_MSG_FastNo0x10
#define API_APM_FastNo0x20
#define API_MEM_FastNo0x30
// bank a api resource
//-------------------------------------
// system class function api bank a resource allocation
//-------------------------------------
#define API_IRQ_BaseNoA 0x0000 // irq manager in bank a
#define API_SYSERR 0x0001      // system error

#define API_ADFU_BaseNoA 0x0002 // adfu

#define API_TM_BaseNoA0x0008      // time manager in bank a
#define API_SDFS_BaseNoA 0x0010   // sd file system in bank a
#define API_MSG_BaseNoA 0x0018    // message system in bank a
#define API_DEVICE_BaseNoA 0x0020 // device in bank a
//-------------------------------------
// API bank a resource allocation for driver class functions
//-------------------------------------
// Storage class drivers are fixed to allocate 16 bank a resources
#define API_STG_BaseNoA 0x0080
// Virtual memory class drivers are fixed to allocate 16 bank a resources
#define API_VM_BaseNoA 0x0090
// Display drivers are fixed to allocate 16 bank a resources
#define API_UI_BaseNoA 0x00a0
// Keyboard drivers are fixed to allocate 16 bank a resources
#define API_KY_BaseNoA 0x00b0
// File system drivers are fixed to allocate 16 bank a resources
#define API_FS_BaseNoA 0x00c0
// Fast SD card driver is fixed to allocate 16 bank a resources
#define API_SDCardFF_BaseNoA 0x00d0
// I2C driver allocates 16 Banka resources
#define API_I2C_BaseNoA 0x00e0
#define API_SDRAM_BaseNoA 0x00f0
//**************************************************************************
// bank b api resource
//-------------------------------------
// api bank b resource allocation for system class functions
//-------------------------------------
#define API_DRV_BaseNoB 0x1000    // Driver management
#define API_APM_BaseNoB 0x1008    // AP management
#define API_DEVICE_BaseNoB 0x1010 // Device management
//-------------------------------------
// API bank B resource allocation for driver class functions
//-------------------------------------
// File system is fixed to allocate 32 bank B resources
#define API_FS_BaseNoB 0x1080
// Display driver is fixed to allocate 16 bank B resources
#define API_UI_BaseNoB 0x10a0
// Memory driver is fixed to allocate 16 bank B resources
#define API_STG_BaseNoB 0x10b0
// Memory driver is fixed to allocate 16 bank B resources
#define API_SDCardFF_BaseNoB 0x10c0
//**************************************************************************

// ACTAPI end

// display.h

typedef struct
{
    char x;      // column position
    char y;      // row position
    char width;  // width
    char height; // height
} region_t;

// RCODE
#define API_PutChar 0x00
#define API_PutS 0x01
#define API_PutImage 0x02
#define API_GetFontPoint 0x03
#define API_UpdateScreen 0x04
#define API_SetAsciiFont 0x05
#define API_SetTextPos 0x06
#define API_GetTextPos 0x07
#define API_GetDispBufAddr 0x08

// BANKA
#define API_ClearScreen 0x0000 + API_UI_BaseNoA
#define API_PutSDImage0x0001 +API_UI_BaseNoA
#define API_InvertRegion 0x0002 + API_UI_BaseNoA
#define API_SetContrast 0x0003 + API_UI_BaseNoA
#define API_HoriScroll0x0004 +API_UI_BaseNoA
#define API_StandbyScreen 0x0005 + API_UI_BaseNoA
#define API_MsgBox 0x000f + API_UI_BaseNoA

// BANKB
#define API_ShowLogo 0x0001 + API_UI_BaseNoB

// ld  de,LWRD fillregion
// ld  bc,LWRD p_fill_buf
// mPutImage
//  Write the display content into the display Buffer imageregion: display area imageaddr: display content pointer
void PutImage(/* hl */ region_t *imageregion, /* de */ char *imageaddr) __naked __sdcccall(1)
{
    (void)imageregion;
    (void)imageaddr;
    API_RST20_two_param(API_PutImage /* a */, imageregion /* hl */, imageaddr /* de */);
    __asm__("ret");
    // de=pointer to the image range structure region_t
    // bc=address of the displayed content
}

void ClearScreen(/* hl */ region_t *imageregion) __naked __sdcccall(1)
{
    (void)imageregion;
    API_RST10_one_param(API_ClearScreen /* a */, imageregion /* hl */);
    __asm__("ret");
    // de=pointer to the image range structure region_t
}

void SetTextPos(uint8_t col /* a */, uint8_t row /* l */) __naked __sdcccall(1)
{
    (void)col;
    (void)row;
    API_RST20_two_param(API_SetTextPos /* a */, col /* stack */, row /* de */);
    __asm__("ret");
    // e = the number of columns on the screen. 0~127
    // c = the number of rows on the screen. 0~31
}

// Output character code: Ascii code, GB code, BIG5 code
void PutChar(uint16_t code) __naked __sdcccall(1)
{
    (void)code;
    API_RST20_one_param(API_PutChar /* a */, code /* hl */);
    __asm__("ret");
    // de=area code
    // bc=screen position after display
}

void PutS(/* hl */ char *str, /* de */ uint16_t strlen) __naked __sdcccall(1)
{
    (void)str;
    (void)strlen;
    API_RST20_two_param(API_PutS /* a */, str /* stack? */, (uint8_t)strlen /* de */);
    __asm__("ret");
    //** de= string first address
    //** c= string output length
}

extern void PutS_2(/* hl */ char *str, /* de */ uint16_t strlen) __naked __sdcccall(1);

//Get the current power level
//para: none
//ret: 0 ~ 15 power level
extern unsigned char GetBattery(void) __naked __sdcccall(1);

void UpdateScreen(/* hl */ region_t *imageregion) __naked __sdcccall(1)
{
    (void)imageregion;
    API_RST20_one_param(API_UpdateScreen /* a */, imageregion /* hl */);
    __asm__("ret");
    // de=pointer to the image range structure region_t
}

// FontID
#define FONT_TYPE_TINY 0xff
#define FONT_TYPE_TINY_INVERT 0xff
#define FONT_TYPE_SMALL 0
#define FONT_TYPE_SMALL_INVERT 1
#define FONT_TYPE_LARGE 4
#define FONT_TYPE_LARGE_INVERT 0xff
#define FONT_TYPE_DEFAULT FONT_TYPE_SMALL

// Set Ascii font FontID see the definition above
void SetAsciiFont(unsigned char FontID) __naked __sdcccall(1)
{
    (void)FontID;
    API_RST20_one_param(API_SetAsciiFont /* a */, FontID /* hl */);
    __asm__("ret");
    // e=Font selection 0:6*8 1:8*16
}

#define API_MSG_PutSysMsg 0x10
#define API_MSG_GetSysMsg 0x11

#define Msg_KeyNull 0x00

#define Msg_KeyMenu 0x10
#define Msg_KeyREC 0x11
#define Msg_KeyEQ0x12

#define Msg_KeyPlayPause 0x01
#define Msg_KeyLoop 0x02
#define Msg_KeyVolSub 0x03
#define Msg_KeyVolAdd 0x04
#define Msg_KeyLast 0x05
#define Msg_KeyNext 0x06

#define Msg_KeyShortUp0x30 // �̰���̧��
#define Msg_KeyLongUp 0x31 // ������̧��

// #define Msg_KeyStandby0x21
#define Msg_KeyHold 0x22
#define Msg_KeyUnHold 0x24

unsigned char GetSysMsg(void)
{
    return API_RST8_no_params(API_MSG_GetSysMsg);
}


#ifndef NULL
#define NULL ((void *)0)
#endif

#define IMGADDRNULL ((void *)0xffff)

#include <stdio.h>
#include <string.h>

char *itoa_3(uint16_t i, char *buf)
{
    buf[0] = (i % 1000) / 100 + '0';
    buf[1] = (i % 100) / 10 + '0';
    buf[2] = (i % 10) + '0';
    buf[3] = 0;

    return buf;
}

const char hourglass[] = {
    0x00, 0x00, 0x08, 0x41, 0x10, 0xA2, 0x29, 0x45, 0x39,/* 0xE7, 0x4A, 0x69, 0x5A, 0xEB, 0x6B,
    0x6D, 0x7B, 0xCF, 0x73, 0x8E, 0x6B, 0x6D, 0x5A, 0xEB, 0x52, 0x8A, 0x42, 0x08, 0x31, 0x86, 0x18,
    0xE3, 0x08, 0x61, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x18, 0xE3, 0x42, 0x08, 0x63,
    0x2C, 0x8C, 0x71, 0xA5, 0x34, 0xBD, 0xF7, 0xCE, 0x79, 0xE7, 0x1C, 0xDE, 0xDB, 0xCE, 0x79, 0xBD,
    0xF7, 0xAD, 0x55, 0x94, 0x92, 0x7B, 0xCF, 0x4A, 0x69, 0x29, 0x45, 0x10, 0x82, 0x00, 0x00, 0x00,
    0x00, 0x18, 0xE3, 0x42, 0x28, 0x84, 0x10, 0xA5, 0x14, 0xC6, 0x18, 0xCE, 0x79, 0xDE, 0xFB, 0xE7,
    0x3C, 0xEF, 0x7D, 0xEF, 0x5D, 0xE7, 0x3C, 0xDE, 0xFB, 0xD6, 0x9A, 0xC6, 0x18, 0xB5, 0xB6, 0x8C,
    0x51, 0x63, 0x2C, 0x39, 0xC7, 0x18, 0xC3, 0x08, 0x41, 0x39, 0xE7, 0x7B, 0xEF, 0xD6, 0x9A, 0xE7,
    0x3C, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xDF, 0xFF, 0xDF, 0xF7, 0xBE, 0xF7, 0xBE, 0xF7, 0xBE, 0xFF,
    0xDF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xDF, 0xDE, 0xDB, 0xBD, 0xF7, 0x73, 0xAE, 0x42, 0x08, 0x18,
    0xC3, 0x5A, 0xCB, 0x9C, 0xD3, 0xE7, 0x3C, 0xEF, 0x7D, 0xEF, 0x7D, 0xD6, 0xBA, 0xC6, 0x18, 0xAD,
    0x75, 0xAD, 0x75, 0xAD, 0x95, 0xAD, 0x96, 0xB5, 0xB6, 0xCE, 0x59, 0xDE, 0xDB, 0xF7, 0x9E, 0xEF,
    0x5D, 0xDE, 0xDB, 0xA5, 0x34, 0x7B, 0xCF, 0x39, 0xC7, 0x7B, 0xEF, 0xB5, 0xB6, 0xF7, 0xBE, 0xCE,
    0x79, 0x84, 0x10, 0x4A, 0x6A, 0x52, 0x90, 0x6B, 0xB5, 0x8D, 0x17, 0x9D, 0x78, 0x8C, 0xF8, 0x73,
    0xB6, 0x62, 0xEF, 0x5A, 0xEC, 0x9C, 0xD3, 0xDE, 0xFB, 0xFF, 0xDF, 0xE7, 0x1C, 0xCE, 0x59, 0x63,
    0x2C, 0x84, 0x30, 0xBD, 0xD7, 0xDE, 0xFB, 0x52, 0xAB, 0x10, 0x85, 0x18, 0xCD, 0x32, 0x94, 0x4C,
    0xBC, 0x65, 0xFD, 0x76, 0x5D, 0x5D, 0x9D, 0x44, 0x3B, 0x29, 0xF2, 0x18, 0xAB, 0x18, 0xC4, 0x7B,
    0xCF, 0xF7, 0x9E, 0xEF, 0x7D, 0xE7, 0x1C, 0x7B, 0xCF, 0x8C, 0x71, 0xBD, 0xF7, 0x94, 0xB2, 0x29,
    0xA9, 0x22, 0x92, 0x4D, 0x5D, 0x5E, 0x3F, 0x76, 0xDF, 0x97, 0x7F, 0x9F, 0x9F, 0x87, 0x3F, 0x6E,
    0x9F, 0x5E, 0x1F, 0x44, 0xBB, 0x19, 0xCE, 0x29, 0x87, 0xC6, 0x18, 0xFF, 0xFF, 0xFF, 0xFF, 0x8C,
    0x71, 0x84, 0x30, 0xB5, 0xB6, 0x8C, 0x30, 0x64, 0x78, 0x3C, 0xFE, 0x55, 0xDF, 0x66, 0x5F, 0x8F,
    0x3F, 0xBF, 0xBF, 0xC7, 0xDF, 0xA7, 0x9F, 0x7E, 0xFF, 0x5E, 0x3F, 0x4D, 0xBF, 0x3C, 0x9C, 0x74,
    0x54, 0x94, 0x92, 0xF7, 0xBE, 0xEF, 0x7D, 0x84, 0x10, 0x84, 0x10, 0xB5, 0xB6, 0xAD, 0x76, 0x4C,
    0xDE, 0x45, 0x3F, 0x5D, 0xFF, 0x6E, 0x7F, 0x97, 0x5F, 0xCF, 0xDF, 0xDF, 0xDF, 0xB7, 0xBF, 0x7F,
    0x1F, 0x5E, 0x3F, 0x4D, 0xBF, 0x3D, 0x1F, 0x6C, 0xFB, 0xB5, 0xB6, 0xEF, 0x7D, 0xDE, 0xFB, 0x73,
    0xAE, 0x73, 0x8E, 0xB5, 0x96, 0xCE, 0x9B, 0x4C, 0xFF, 0x4D, 0x5F, 0x65, 0xFF, 0x76, 0x7F, 0x8F,
    0x3F, 0xB7, 0xBF, 0xC7, 0xBF, 0xA7, 0x9F, 0x76, 0xFF, 0x5E, 0x3F, 0x4D, 0xBF, 0x3D, 0x1F, 0x65,
    0x1D, 0xE7, 0x5E, 0xE7, 0x1C, 0xCE, 0x59, 0x6B, 0x4D, 0x63, 0x2C, 0xAD, 0x55, 0xD6, 0xDD, 0x4C,
    0xFF, 0x4D, 0x5F, 0x6D, 0xFF, 0x7E, 0x7F, 0x76, 0xBF, 0x87, 0x3F, 0x8F, 0x5F, 0x7F, 0x1F, 0x66,
    0x7F, 0x5E, 0x1F, 0x4D, 0x9F, 0x3D, 0x1F, 0x75, 0x7D, 0xE7, 0x7F, 0xDE, 0xDB, 0xB5, 0xB6, 0x5A,
    0xCB, 0x5A, 0xEB, 0xA5, 0x14, 0xD6, 0xBC, 0x4C, 0xDE, 0x44, 0xFF, 0x5D, 0x9F, 0x76, 0x1F, 0x5E,
    0x1F, 0x56, 0x1F, 0x56, 0x3F, 0x56, 0x1F, 0x45, 0xBF, 0x3D, 0x3F, 0x34, 0xDF, 0x34, 0x9F, 0x7D,
    0x5C, 0xEF, 0x9F, 0xD6, 0x9A, 0xAD, 0x75, 0x52, 0x8A, 0x52, 0xAA, 0x9C, 0xF3, 0xE7, 0x3D, 0x54,
    0x1C, 0x33, 0xFF, 0x55, 0x1F, 0x6D, 0xBF, 0x55, 0x9F, 0x35, 0x5F, 0x3D, 0x7F, 0x35, 0x5F, 0x2C,
    0xFF, 0x24, 0x7F, 0x23, 0xFF, 0x2B, 0xBF, 0x84, 0xFA, 0xF7, 0xDF, 0xCE, 0x79, 0xA5, 0x14, 0x4A,
    0x69, 0x4A, 0x49, 0x94, 0x92, 0xEF, 0x7D, 0xB5, 0xF9, 0x8D, 0xFF, 0x85, 0xFF, 0x96, 0x3F, 0x75,
    0xDF, 0x3D, 0x1F, 0x3D, 0x3F, 0x3C, 0xFF, 0x3C, 0xBE, 0x4C, 0xBE, 0x65, 0x1F, 0x9E, 0x3E, 0xC6,
    0x7A, 0xFF, 0xFF, 0xBD, 0xF7, 0x84, 0x30, 0x39, 0xC7, 0x42, 0x08, 0x84, 0x30, 0xE7, 0x3C, 0xD6,
    0xDB, 0xDF, 0x7D, 0xE7, 0xDF, 0xE7, 0x9F, 0xCF, 0x7F, 0xB7, 0x3F, 0xAF, 0x3F, 0x9E, 0x7E, 0x8D,
    0x9B, 0xB6, 0x9D, 0xE7, 0xBF, 0xDF, 0x3D, 0xEF, 0x7D, 0xFF, 0xFF, 0xAD, 0x75, 0x73, 0x8E, 0x29,
    0x45, 0x21, 0x04, 0x5A, 0xCB, 0xA5, 0x34, 0xC6, 0x38, 0xD6, 0xDB, 0xE7, 0x7E, 0xEF, 0xDF, 0xF7,
    0xDF, 0xDF, 0xDF, 0xCF, 0x7F, 0xB6, 0x3A, 0xAD, 0xF9, 0xE7, 0xBF, 0xE7, 0x7E, 0xE7, 0x1C, 0xEF,
    0x5D, 0xD6, 0xBA, 0x84, 0x10, 0x42, 0x28, 0x10, 0xA2, 0x08, 0x61, 0x31, 0x86, 0x73, 0x8E, 0xAD,
    0x55, 0xE7, 0x1C, 0xD6, 0xFC, 0xE7, 0x9E, 0xF7, 0xDF, 0xD7, 0xBF, 0x86, 0x7E, 0xAD, 0xB7, 0xDF,
    0x3D, 0xE7, 0x9E, 0xE7, 0x5D, 0xFF, 0xFF, 0xD6, 0xBA, 0xB5, 0xB6, 0x5A, 0xEB, 0x21, 0x24, 0x08,
    0x41, 0x00, 0x20, 0x21, 0x04, 0x52, 0x8A, 0x94, 0x92, 0xDE, 0xFB, 0xEF, 0x5D, 0xEF, 0x7D, 0xEF,
    0xBE, 0xE7, 0xBF, 0x8D, 0xFD, 0xD6, 0xDB, 0xEF, 0x9E, 0xF7, 0x9E, 0xFF, 0xFF, 0xFF, 0xFF, 0xCE,
    0x59, 0x9C, 0xD3, 0x4A, 0x49, 0x10, 0xA2, 0x00, 0x20, 0x00, 0x00, 0x10, 0x82, 0x39, 0xC7, 0x7B,
    0xCF, 0xD6, 0xBA, 0xEF, 0x5D, 0xFF, 0xFF, 0xE7, 0x5D, 0xD7, 0x3F, 0x9E, 0x7F, 0xC6, 0xFE, 0xEF,
    0x9E, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xBD, 0xF7, 0x84, 0x30, 0x39, 0xC7, 0x08, 0x61, 0x00,
    0x00, 0x00, 0x20, 0x21, 0x04, 0x52, 0xAA, 0x94, 0x92, 0xE7, 0x1C, 0xEF, 0x7D, 0xEF, 0x7E, 0xBE,
    0xFE, 0xBF, 0x1F, 0x8E, 0x7F, 0x7E, 0x5F, 0xB6, 0xBE, 0xF7, 0xBE, 0xFF, 0xFF, 0xFF, 0xFF, 0xCE,
    0x59, 0xA5, 0x14, 0x4A, 0x69, 0x18, 0xC3, 0x00, 0x20, 0x08, 0x61, 0x31, 0xA6, 0x7B, 0xEF, 0xB5,
    0x96, 0xEF, 0x5D, 0xC6, 0x9B, 0x8D, 0xFE, 0xB6, 0xFF, 0x8E, 0x9F, 0x66, 0x3F, 0x55, 0xDF, 0x45,
    0x5F, 0x96, 0x3D, 0xE7, 0x5D, 0xFF, 0xFF, 0xDE, 0xFB, 0xC6, 0x18, 0x6B, 0x4D, 0x29, 0x45, 0x08,
    0x61, 0x21, 0x04, 0x5A, 0xCB, 0xAD, 0x55, 0xCE, 0x79, 0xC6, 0x7B, 0x65, 0x1D, 0x86, 0x1F, 0xAE,
    0xDF, 0x5D, 0xDF, 0x4D, 0xBF, 0x45, 0x7F, 0x3D, 0x1F, 0x3C, 0xFF, 0x8D, 0xDD, 0xE7, 0x3D, 0xEF,
    0x7D, 0xDE, 0xFB, 0x8C, 0x51, 0x4A, 0x49, 0x18, 0xC3, 0x39, 0xE7, 0x84, 0x10, 0xE7, 0x1C, 0xD6,
    0xBB, 0x7D, 0x7D, 0x5D, 0x5F, 0x9E, 0x7F, 0x86, 0x3F, 0x35, 0x1F, 0x35, 0x3F, 0x34, 0xFF, 0x2C,
    0xDF, 0x2C, 0x7F, 0x44, 0x9F, 0xAE, 0x1C, 0xEF, 0x7D, 0xFF, 0xFF, 0xB5, 0x96, 0x73, 0xAE, 0x29,
    0x65, 0x4A, 0x49, 0x94, 0x92, 0xEF, 0x7D, 0xCE, 0x9A, 0xDF, 0xBF, 0xC7, 0x3F, 0xC7, 0x1F, 0xAE,
    0xDF, 0x7E, 0x5F, 0x7E, 0x5F, 0x7E, 0x1F, 0x75, 0x7E, 0x85, 0x9D, 0xAE, 0x9E, 0xE7, 0xBF, 0xD6,
    0xBB, 0xFF, 0xFF, 0xC6, 0x18, 0x8C, 0x71, 0x39, 0xE7, 0x52, 0xAA, 0x9C, 0xF3, 0xE7, 0x5D, 0xEF,
    0x9E, 0xF7, 0xFF, 0xF7, 0xDF, 0xEF, 0xDF, 0xDF, 0xDF, 0xDF, 0xDF, 0xD7, 0xDF, 0xD7, 0x9F, 0xBE,
    0xBD, 0xC6, 0xBC, 0xD7, 0x1D, 0xF7, 0xFF, 0xDE, 0xFB, 0xFF, 0xDF, 0xD6, 0x9A, 0xAD, 0x55, 0x52,
    0x8A, 0x52, 0xAA, 0x9C, 0xF3, 0xDE, 0xFB, 0xFF, 0xDF, 0xFF, 0xFF, 0xF7, 0xFF, 0xF7, 0xDF, 0xEF,
    0xDF, 0xE7, 0xDF, 0xE7, 0xDF, 0xE7, 0xDF, 0xD7, 0x1D, 0xD6, 0xFD, 0xDF, 0x3D, 0xFF, 0xFF, 0xF7,
    0x9E, 0xF7, 0x9E, 0xD6, 0x9A, 0xAD, 0x55, 0x52, 0x8A, 0x52, 0xAA, 0x9C, 0xF3, 0xDE, 0xFB, 0xFF,
    0xDF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF7, 0xFF, 0xF7, 0xFF, 0xF7, 0xFF, 0xF7, 0xFF, 0xF7, 0xFF, 0xE7,
    0x5E, 0xE7, 0x5D, 0xEF, 0x7D, 0xFF, 0xFF, 0xF7, 0xBE, 0xEF, 0x7D, 0xD6, 0xBA, 0xAD, 0x75, 0x52,
    0xAA, 0x63, 0x0C, 0xA5, 0x34, 0xEF, 0x5D, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF7,
    0xDF, 0xF7, 0xFF, 0xF7, 0xFF, 0xF7, 0xDF, 0xE7, 0x5D, 0xF7, 0x9E, 0xFF, 0xDF, 0xFF, 0xFF, 0xF7,
    0xBE, 0xF7, 0xBE, 0xD6, 0xBA, 0xAD, 0x75, 0x52, 0xAA, 0x73, 0x8E, 0xB5, 0x96, 0xE7, 0x1C, 0xFF,
    0xDF, 0xEF, 0x7D, 0xBD, 0xF7, 0xBD, 0xF7, 0xDE, 0xFB, 0xF7, 0xBE, 0xF7, 0xDF, 0xEF, 0x9E, 0xD6,
    0xBA, 0xB5, 0xB6, 0xBD, 0xD7, 0xF7, 0x9E, 0xEF, 0x5D, 0xF7, 0x9E, 0xD6, 0xBA, 0xAD, 0x75, 0x52,
    0xAA, 0x7B, 0xEF, 0xBD, 0xD7, 0xBD, 0xF7, 0x5A, 0xEB, 0x31, 0xA6, 0x63, 0x2C, 0x94, 0x91, 0xB5,
    0x96, 0xC6, 0x38, 0xCE, 0x79, 0xC6, 0x38, 0xB5, 0x96, 0x8C, 0x51, 0x5A, 0xCB, 0x39, 0xE7, 0x5A,
    0xEB, 0xEF, 0x5D, 0xD6, 0xBA, 0xAD, 0x75, 0x52, 0xAA, 0x8C, 0x71, 0xC6, 0x18, 0x84, 0x30, 0x29,
    0x65, 0x4A, 0x49, 0x6B, 0x4D, 0x8C, 0x51, 0xA5, 0x34, 0xBD, 0xD7, 0xC6, 0x18, 0xBD, 0xF7, 0xAD,
    0x55, 0x8C, 0x50, 0x63, 0x2C, 0x39, 0xE7, 0x21, 0x04, 0xAD, 0x75, 0xD6, 0xBA, 0xAD, 0x75, 0x52,
    0xAA, 0x73, 0x8E, 0xAD, 0x55, 0xB5, 0xB6, 0x5A, 0xEB, 0x5A, 0xCB, 0x6B, 0x6D, 0x8C, 0x51, 0xA5,
    0x34, 0xBD, 0xD7, 0xC6, 0x18, 0xBD, 0xF7, 0xAD, 0x55, 0x8C, 0x50, 0x63, 0x2C, 0x4A, 0x69, 0x52,
    0xAA, 0xD6, 0x9A, 0xBD, 0xD7, 0x8C, 0x71, 0x42, 0x08, 0x5A, 0xCB, 0x94, 0xB2, 0xE7, 0x1C, 0xE7,
    0x1C, 0xCE, 0x79, 0xBD, 0xF7, 0xC6, 0x18, 0xCE, 0x79, 0xDE, 0xDA, 0xDE, 0xFB, 0xDE, 0xDB, 0xD6,
    0x9A, 0xC6, 0x18, 0xBD, 0xD7, 0xCE, 0x79, 0xE7, 0x3C, 0xE7, 0x1C, 0xA5, 0x14, 0x6B, 0x6D, 0x29,
    0x65, 0x29, 0x45, 0x4A, 0x69, 0x84, 0x10, 0x94, 0xB2, 0xAD, 0x55, 0xB5, 0xB6, 0xBD, 0xF7, 0xBD,
    0xF7, 0xC6, 0x18, 0xC6, 0x18, 0xC6, 0x18, 0xBD, 0xF7, 0xBD, 0xD7, 0xB5, 0x96, 0xA5, 0x34, 0x94,
    0x92, 0x84, 0x10, 0x52, 0xAA, 0x31, 0x86, 0x10, 0xA2, 0x08, 0x61, 0x18, 0xE3, 0x39, 0xC7, 0x52,
    0x8A, 0x6B, 0x4D, 0x7B, 0xCF, 0x84, 0x30, 0x8C, 0x51, 0x8C, 0x71, 0x8C, 0x71, 0x8C, 0x71, 0x84,
    0x30, 0x84, 0x10, 0x73, 0x8E, 0x63, 0x0C, 0x4A, 0x69, 0x39, 0xC7, 0x21, 0x04, 0x08, 0x61, 0x00,
    0x20*/
};

__sfr __at(BATTERY_MON_REG) REG_BATTERY_MON;

//__sfr __at(WATCHDOG_REG) REG_WATCHDOG;
uint8_t __at(0x8000) LCD_CMD;

__sfr __at(GPIOC_DATA_REG) REG_GPIOC_DATA;

static inline void gpio_c2_off(void)
{
    REG_GPIOC_DATA &= 0xfb;
}

static inline void gpio_c2_on(void)
{
    REG_GPIOC_DATA |= 0x4;
}

static inline void ssd1789_cmd(uint8_t cmd)
{
    gpio_c2_off();
    LCD_CMD = cmd;
}

static inline void ssd1789_data(uint8_t cmd)
{
    gpio_c2_on();
    LCD_CMD = cmd;
}

static inline void ssd1789_set_col(uint8_t start, uint8_t end)
{
    ssd1789_cmd(0x15);
    ssd1789_data(start);
    ssd1789_data(end);
}

static inline void ssd1789_set_page(uint8_t start, uint8_t end)
{
    ssd1789_cmd(0x75);
    ssd1789_data(start);
    ssd1789_data(end);
}

void main(void)
{
    // PutImage(NULL, IMGADDRNULL);
    __asm__("ld bc, #0");      // null
    __asm__("ld de, #0xffff"); // imgaddr
    __asm__("ld a, #2");
    __asm__("rst 0x20");

    __asm__("ld de, #0"); // null
    __asm__("ld hl, #0xA0");
    __asm__("rst 0x10");
    // ClearScreen(NULL);

    // SetAsciiFont(FONT_TYPE_TINY);

    char buffer[20] = {"FORRO!!1"};
    buffer[0] = 'G';


    itoa_3(REG_BATTERY_MON & 0xf, &buffer[3]);
    // SetTextPos(0, 0x40);
    PutS_2(buffer, -1);

    while (GetSysMsg() != 4)
    {
        Watchdog_Pet();
    }

    // ClearScreen:
    __asm__("ld de, #0"); // null
    __asm__("ld hl, #0xA0");
    __asm__("rst 0x10");


    ssd1789_set_col(54, 64);
    ssd1789_set_page(46, 81);
    ssd1789_cmd(0x5c);
    gpio_c2_on();
    uint16_t pos = 0;
    for (pos = 0; pos < sizeof(hourglass); pos++)
    {
        LCD_CMD = hourglass[pos];
    }
    
    while (GetSysMsg() != 4)
    {
        Watchdog_Pet();
    }
    __asm__("ld de, #0"); // null
    __asm__("ld hl, #0xA0");
    __asm__("rst 0x10");
#if 0
    API_Screen_Clear(0 /* hl */, 0xffff /* de */);
    API_Update_Screen(0);

    API_Set_Text_Pos(0x0, 0x40);
    //API_PutS("HI FROM C", 0x00ff);

    while(1)
    {
   Watchdog_Pet();
   if (API_Get_Sys_Msg() == 4)
   {
  break;
   }
    }

    API_Screen_Clear(0 /* hl */, 0x00ff /* de */);
    API_Update_Screen(0);

    API_Set_Text_Pos(0x0, 0x60);
    //API_PutS("cocus was here", 0x00ff);

    while(1)
    {
   Watchdog_Pet();
   if (API_Get_Sys_Msg() == 4)
   {
  API_Set_Text_Pos(0x0, 0x80);
  //API_PutS("bye!", 0x00ff);
  //API_Update_Screen(0);

  break;
   }
    }

#endif
}
